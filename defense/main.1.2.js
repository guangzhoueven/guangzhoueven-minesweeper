
var _TD={a:[],retina:window.devicePixelRatio|| 1,init:function(d){delete this.init;var a,b={width:16,height:16,show_monster_life:true,fps:0,exp_fps:24,exp_fps_half:12,exp_fps_quarter:6,exp_fps_eighth:4,stage_data:{},defaultSettings:function(){return {step_time:36,grid_size:32* _TD.retina,grid_x:18,grid_y:16,padding:10* _TD.retina,global_speed:0.1}},init:function(e){this.obj_board= b.lang.$e(e);this.canvas= this.obj_board.getElementsByTagName("canvas")[0];if(!this.canvas.getContext){return};this.ctx= this.canvas.getContext("2d");this.monster_type_count= b.getDefaultMonsterAttributes();this.iframe= 0;this.last_iframe_time= ( new Date()).getTime();this.fps= 0;window.oncontextmenu= function(f){if(b.mode== 1){b.stage.cancelPreBuild()};f.preventDefault()};this.start()},start:function(){clearTimeout(this._st);b.log("Start!");var g=this;this._exp_fps_0= this.exp_fps- 0.4;this._exp_fps_1= this.exp_fps+ 0.4;this.mode= 0;this.eventManager.clear();this.lang.mix(this,this.defaultSettings());this.stage=  new b.Stage("stage-main",b.getDefaultStageData("stage_main"));this.canvas.setAttribute("width",this.stage.width);this.canvas.setAttribute("height",this.stage.height);this.canvas.style.width= (this.stage.width/ _TD.retina)+ "px";this.canvas.style.height= (this.stage.height/ _TD.retina)+ "px";this.canvas.onmousemove= function(f){var h=g.getEventXY.call(g,f);g.hover(h[0],h[1])};this.canvas.onclick= function(f){var h=g.getEventXY.call(g,f);g.click(h[0],h[1])};this.stage.state= 1;this.step();return this},step:function(){this.iframe++;if(this.iframe% 50== 0){var k=( new Date()).getTime(),j=this.step_time;this.fps= Math.round(500000/ (k- this.last_iframe_time))/ 10;this.last_iframe_time= k;if(this.fps< this._exp_fps_0&& j> 1){j--}else {if(this.fps> this._exp_fps_1){j++}};this.step_time= j};if(this.iframe% 2400== 0){b.gc()};this.stage.step();this.stage.render();var g=this;this._st= setTimeout(function(){g.step()},this.step_time)},getEventXY:function(f){var l=b.lang.$e("wrapper"),m=f.clientX- l.offsetLeft- this.canvas.offsetLeft+ Math.max(document.documentElement.scrollLeft,document.body.scrollLeft),n=f.clientY- l.offsetTop- this.canvas.offsetTop+ Math.max(document.documentElement.scrollTop,document.body.scrollTop);return [m* _TD.retina,n* _TD.retina]},hover:function(m,n){this.eventManager.hover(m,n)},click:function(m,n){this.eventManager.click(m,n)},mouseHand:function(o){this.canvas.style.cursor= o?"pointer":"default"},log:function(p){console.log(p)},gc:function(){if(window.CollectGarbage){CollectGarbage();setTimeout(CollectGarbage,1)}}};for(a= 0;this.a[a];a++){this.a[a](b)};delete this.a;b.init(d)}};_TD.a.push(function(b){b.lang= {$e:function(q){return document.getElementById(q)},$c:function(A,s,z){var u=document.createElement(A);s= s|| {};for(var w in s){if(s.hasOwnProperty(w)){u.setAttribute(w,s[w])}};if(z){z.appendChild(u)};return u},strLeft:function(D,C){var E=D.slice(0,C),a=E.replace(/[^\x00-\xff]/g,"**").length;if(a<= C){return E};a-= E.length;switch(a){case 0:return E;case C:return D.slice(0,C>> 1);default:var w=C- a,F=D.slice(w,C),B=F.replace(/[\x00-\xff]/g,"").length;return B?D.slice(0,w)+ this.arguments.callee(F,B):D.slice(0,w)}},strLen2:function(D){return D.replace(/[^\x00-\xff]/g,"**").length},each:function(I,G){if(Array.prototype.forEach){I.forEach(G)}else {for(var a=0,H=I.length;a< H;a++){G(I[a])}}},any:function(I,G){for(var a=0,H=I.length;a< H;a++){if(G(I[a])){return I[a]}};return null},shift:function(I,G){while(I[0]){G(I.shift())}},rndSort:function(I){var J=I.concat();return J.sort(function(){return Math.random()- 0.5})},_rndRGB2:function(o){var D=o.toString(16);return D.length== 2?D:("0"+ D)},rndRGB:function(){var M=Math.floor(Math.random()* 256),L=Math.floor(Math.random()* 256),K=Math.floor(Math.random()* 256);return "#"+ this._rndRGB2(M)+ this._rndRGB2(L)+ this._rndRGB2(K)},rgb2Arr:function(N){if(N.length!= 7){return [0,0,0]};var M=N.substr(1,2),L=N.substr(3,2),K=N.substr(3,2);return [parseInt(M,16),parseInt(L,16),parseInt(K,16)]},rndStr:function(C){C= C|| 16;var O="1234567890abcdefghijklmnopqrstuvwxyz",J=[],a,P=O.length,M;for(a= 0;a< C;a++){M= Math.floor(Math.random()* P);J.push(O.substr(M,1))};return J.join("")},nullFunc:function(){},arrayEqual:function(Q,R){var a,H=Q.length;if(H!= R.length){return false};for(a= 0;a< H;a++){if(Q[a]!= R[a]){return false}};return true},mix:function(M,D,S){if(!D||  !M){return M};for(var T in D){if(D.hasOwnProperty(T)&& (S!== false||  !(T in  M))){M[T]= D[T]}};return M}}});_TD.a.push(function(b){b.default_upgrade_rule= function(U,V){return V* 1.2};b.getDefaultBuildingAttributes= function(X){var W={"wall":{damage:0,range:0,speed:0,bullet_speed:0,life:100,cost:5},"hammer":{damage:0,range:0,speed:0,bullet_speed:0,life:100,cost:0},"LMG":{damage:1,range:3,max_range:10,speed:6,bullet_speed:6,life:100,cost:180},"HMG":{damage:2,range:4,max_range:10,speed:8,bullet_speed:6,life:100,cost:800},"cannon":{damage:20,range:8,max_range:10,speed:1,bullet_speed:12,life:100,cost:6000,bullet_type:3},"laser_gun":{damage:10,range:6,max_range:10,speed:2,life:100,cost:3200,bullet_type:2}};return W[X]|| {}}});_TD.a.push(function(b){function Y(){if(!this.is_valid||  !this.grid){return};var bh=b.ctx;bh.strokeStyle= "#000";bh.lineWidth= 1;bh.fillStyle= this.color;bh.beginPath();bh.arc(this.cx,this.cy,this.r,0,Math.PI* 2,true);bh.closePath();bh.fill();bh.stroke();if(b.show_monster_life){var D=Math.floor(b.grid_size/ 4),H=D* 2- 2* _TD.retina;bh.fillStyle= "#000";bh.beginPath();bh.fillRect(this.cx- D,this.cy- this.r- 6,D* 2,4* _TD.retina);bh.closePath();bh.fillStyle= "#f00";bh.beginPath();bh.fillRect(this.cx- D+ _TD.retina,this.cy- this.r- (6- _TD.retina),this.life* H/ this.life0,2* _TD.retina);bh.closePath()}}b.getDefaultMonsterAttributes= function(bc){var bb=[{name:"monster 300",desc:"\u751f\u547d\u503c\u5f88\u9ad8\u7684\u602a\u7269",speed:5,max_speed:10,life:60,damage:5},{name:"monster 2",desc:"\u7a0d\u5f3a\u4e00\u4e9b\u7684\u5c0f\u602a",speed:6,max_speed:20,life:10,damage:2},{name:"monster 1",desc:"\u6700\u5f31\u5c0f\u7684\u602a\u7269",speed:7,max_speed:10,life:10,damage:1},{name:"monster 500",desc:"\u751f\u547d\u503c\u5f88\u5f3a\u7684\u5c0f\u602a",speed:8,max_speed:10,life:100,damage:3},{name:"monster 50",desc:"\u9632\u5fa1\u5f88\u5f3a\u7684\u5c0f\u602a",speed:9,max_speed:10,life:10,damage:3},{name:"monster damage",desc:"\u4f24\u5bb3\u503c\u5f88\u5927\u7684\u5c0f\u602a",speed:10,max_speed:14,life:10,damage:10},{name:"monster speed",desc:"\u901f\u5ea6\u8f83\u5feb\u7684\u5c0f\u602a",speed:12,max_speed:30,life:10,damage:3},{name:"monster speed-life",desc:"\u901f\u5ea6\u3001\u751f\u547d\u90fd\u8f83\u9ad8\u7684\u602a\u7269",speed:15,max_speed:30,life:20,damage:3},{name:"monster speed-2",desc:"\u901f\u5ea6\u751f\u547d\u90fd\u9ad8\u7684\u602a\u7269",speed:20,max_speed:40,life:30,damage:4}];if( typeof bc== "undefined"){return bb.length};var Z=bb[bc]|| bb[0],ba={};b.lang.mix(ba,Z);if(!ba.render){ba.render= Y};return ba};b.makeMonsters= function(C,bg){var J=[],be=0,a,bd,bf,M,H=b.monster_type_count;if(!bg){bg= [];for(a= 0;a< H;a++){bg.push(a)}};while(be< C){bf= C- be;bd= Math.min(Math.floor(Math.random()* bf)+ 1,3);M= Math.floor(Math.random()* H);J.push([bd,bg[M]]);be+= bd};return J}});_TD.a.push(function(b){var bi=function(){var bk=b.getDefaultStageData("_endless");this.config= bk.config;this.life= this.config.life;this.money= this.config.money;this.difficulty= this.config.difficulty;this.wave_damage= 0;this.wave= 0;this.has_weapon= false;this.map=  new b.Map("main-map",b.lang.mix({stage:this,is_main_map:true},bk.map));this.panel_map=  new b.Map("panel-map",b.lang.mix({stage:this,is_main_map:false},bk.panel));this.panel=  new b.Panel("panel",b.lang.mix({x:bk.panel.x,y:b.padding,stage:this,main_map:this.map}));this.wait_new_wave= this.config.wait_new_wave},bj=function(){var bl=this.wave;if(bl== 0){if(!this.has_weapon){return}else {this.panel.btn_pause.show()}};if(this.map.monsters.length== 0){if(bl> 0&& this.wait_new_wave== this.config.wait_new_wave- 1){var bm=0;if(bl% 5== 0){bm= 5};if(this.life+ bm> 100){bm= 100- this.life};if(bm> 0){b.recover(bm)}};if(this.wait_new_wave> 0){this.wait_new_wave--;return};this.wait_new_wave= this.config.wait_new_wave;if(bl> 5){if(this.wave_damage== 0){this.difficulty*= 1.05}else {this.difficulty/= 1.05}};this.wave++;this.map._wait_add_monsters= this.wave;this.wave_damage= 0}};b.getDefaultStageData= function(w){var bp=b.padding* 2+ b.grid_size* b.grid_x;var bo=110* _TD.retina;var bq=b.padding* 4+ b.grid_size* b.grid_y;var br=Math.floor(Math.random()* b.grid_x),bt=Math.floor(Math.random()* b.grid_y);var bs=br,bu=bt;while(bs- br+ bu- bt< 2){bs= Math.floor(Math.random()* b.grid_x),bu= Math.floor(Math.random()* b.grid_y)};var bn={stage_main:{width:bp+ bo,height:bq,init:bi,step2:bj},_endless:{map:{grid_x:b.grid_x,grid_y:b.grid_y,x:b.padding,y:b.padding,entrance:[br,bt],exit:[bs,bu],grids_cfg:[]},panel:{x:bp,y:260* _TD.retina,grid_x:3,grid_y:3,grids_cfg:[{pos:[0,0],building:"LMG"},{pos:[1,0],building:"HMG"},{pos:[2,0],building:"cannon"},{pos:[2,2],building:"wall"},{pos:[0,2],building:"hammer"}]},config:{endless:true,wait_new_wave:b.exp_fps* 3,difficulty:1,wave:0,max_wave:-1,money:1200,score:0,life:100}}};return bn[w]|| {}}});_TD.a.push(function(b){b.Element= function(bv,bk){this.id= bv|| ("el-"+ b.lang.rndStr());this.cfg= bk|| {};this.is_valid= true;this.is_visiable=  typeof bk.is_visiable!= "undefined"?bk.is_visiable:true;this.is_paused= false;this.is_hover= false;this.x= this.cfg.x||  -1;this.y= this.cfg.y||  -1;this.width= this.cfg.width|| 0;this.height= this.cfg.height|| 0;this.on_events= bk.on_events|| [];this._init()};b.Element.prototype= {_init:function(){var g=this,a,bw,bx;for(a= 0,bx= this.on_events.length;a< bx;a++){bw= this.on_events[a];switch(bw){case "enter":this.on("enter",function(){g.onEnter()});break;case "out":this.on("out",function(){g.onOut()});break;case "hover":this.on("hover",function(){g.onHover()});break;case "click":this.on("click",function(){g.onClick()});break}};this.caculatePos()},caculatePos:function(){this.cx= this.x+ this.width/ 2;this.cy= this.y+ this.height/ 2;this.x2= this.x+ this.width;this.y2= this.y+ this.height},start:function(){this.is_paused= false},pause:function(){this.is_paused= true},hide:function(){this.is_visiable= false;this.onOut()},show:function(){this.is_visiable= true},del:function(){this.is_valid= false},on:function(by,G){b.eventManager.on(this,by,G)},onEnter:b.lang.nullFunc,onOut:b.lang.nullFunc,onHover:b.lang.nullFunc,onClick:b.lang.nullFunc,onDClick:b.lang.nullFunc,step:b.lang.nullFunc,render:b.lang.nullFunc}});_TD.a.push(function(b){b.eventManager= {ex:-1,ey:-1,_registers:{},ontypes:["enter","hover","out","click"],current_type:"hover",isOn:function(u){return (this.ex!=  -1&& this.ey!=  -1&& this.ex> u.x&& this.ex< u.x2&& this.ey> u.y&& this.ey< u.y2)},_mkElEvtName:function(u,by){return u.id+ "::_evt_::"+ by},on:function(u,by,G){this._registers[this._mkElEvtName(u,by)]= [u,by,G]},removeEventListener:function(u,by){var bw=this._mkElEvtName(u,by);delete this._registers[bw]},clear:function(){delete this._registers;this._registers= {}},step:function(){if(!this.current_type){return};var w,J,u,bz,G,B,g=this,bB=this.ontypes.length,bA,bC=[];for(w in this._registers){if(!this._registers.hasOwnProperty(w)){continue};J= this._registers[w];u= J[0];bz= J[1];G= J[2];if(!u.is_valid){bC.push(u);continue};if(!u.is_visiable){continue};bA= this.isOn(u);if(this.current_type!= "click"){if(bz== "hover"&& u.is_hover&& bA){G();this.current_type= "hover"}else {if(bz== "enter"&&  !u.is_hover&& bA){u.is_hover= true;G();this.current_type= "enter"}else {if(bz== "out"&& u.is_hover&&  !bA){u.is_hover= false;G();this.current_type= "out"}}}}else {if(bA&& bz== "click"){G()}}};b.lang.each(bC,function(bD){for(B= 0;B< bB;B++){g.removeEventListener(bD,g.ontypes[B])}});this.current_type= ""},hover:function(bE,bF){if(this.current_type== "click"){return};this.current_type= "hover";this.ex= bE;this.ey= bF},click:function(bE,bF){this.current_type= "click";this.ex= bE;this.ey= bF}}});_TD.a.push(function(b){var bG={_init:function(bk){this.is_selected= false;this.level= 0;this.killed= 0;this.target= null;bk= bk|| {};this.map= bk.map|| null;this.grid= bk.grid|| null;this.type= bk.type;this.speed= bk.speed;this.bullet_speed= bk.bullet_speed;this.is_pre_building= bk.is_pre_building;this.blink= this.is_pre_building;this.wait_blink= this._default_wait_blink= 20;var bI=b.getDefaultBuildingAttributes(this.type);b.lang.mix(this,bI);this.range_px= this.range* b.grid_size;this.money= this.cost;this.is_weapon= (this.damage!= 0);this.range2= Math.pow(this.range_px,2);this.btype= this.bullet_type|| 1;this.caculatePos();bk.stage.addElement(this,1,this.map.render_level+ this.is_pre_building?3:2)},getUpgradeCost:function(){return Math.floor(this.money* 0.75)},getSellMoney:function(){return Math.floor(this.money* 0.5)|| 1},updateBtnDesc:function(){this.stage.panel.btn_upgrade.desc= b._t("upgrade",[b._t("building_name_"+ this.type),this.level+ 1,this.getUpgradeCost()]);this.stage.panel.btn_sell.desc= b._t("sell",[b._t("building_name_"+ this.type),this.getSellMoney()])},locate:function(bJ){this.grid= bJ;this.map= bJ.map;this.cx= this.grid.cx;this.cy= this.grid.cy;this.x= this.grid.x;this.y= this.grid.y;this.x2= this.grid.x2;this.y2= this.grid.y2;this.width= this.grid.width;this.height= this.grid.height;this.px= this.x+ 0.5;this.py= this.y+ 0.5;this.wait_blink= this._default_wait_blink;this._fire_wait= Math.floor(Math.max(4/ (this.speed* b.global_speed),1));this._fire_wait2= this._fire_wait},remove:function(){if(this.grid&& this.grid.building&& this.grid.building== this){this.grid.building= null};this.hide();this.del()},findTarget:function(){if(!this.is_weapon|| this.is_pre_building ||  !this.grid){return};var bK=this.cx,bL=this.cy,bO=this.range2;if(this.target&& this.target.is_valid){var bM=this.target.cx- bK,bN=this.target.cy- bL;if(bM* bM+ bN* bN<= bO){return}};this.target= b.lang.any(b.lang.rndSort(this.map.monsters),function(bD){var bM=bD.cx- bK,bN=bD.cy- bL;return bM* bM+ bN* bN<= bO})},getTargetPosition:function(){if(!this.target){var bJ=this.map.is_main_map?this.map.entrance:this.grid;return [bJ.cx,bJ.cy]};return [this.target.cx,this.target.cy]},fire:function(){if(!this.target||  !this.target.is_valid){return};var bP=this.muzzle|| [this.cx,this.cy],bK=bP[0],bL=bP[1]; new b.Bullet(null,{building:this,damage:this.damage,target:this.target,speed:this.bullet_speed,type:this.btype,x:bK,y:bL})},tryToFire:function(){if(!this.is_weapon||  !this.target){return};this._fire_wait--;if(this._fire_wait> 0){}else {if(this._fire_wait< 0){this._fire_wait= this._fire_wait2}else {this.fire()}}},_upgrade2:function(w){if(!this._upgrade_records[w]){this._upgrade_records[w]= this[w]};var o=this._upgrade_records[w],bQ="max_"+ w,bS="_upgrade_rule_"+ w,bR=this[bS]|| b.default_upgrade_rule;if(!o|| isNaN(o)){return};o= bR(this.level,o);if(this[bQ]&&  !isNaN(this[bQ])&& this[bQ]< o){o= this[bQ]};this._upgrade_records[w]= o;this[w]= Math.floor(o)},upgrade:function(){if(!this._upgrade_records){this._upgrade_records= {}};var bT=["damage","range","speed","life","shield"],a,H=bT.length;for(a= 0;a< H;a++){this._upgrade2(bT[a])};this.level++;this.range_px= this.range* b.grid_size},tryToUpgrade:function(bU){var bV=this.getUpgradeCost(),bW="";if(bV> this.stage.money){bW= b._t("not_enough_money",[bV])}else {this.stage.money-= bV;this.money+= bV;this.upgrade();bW= b._t("upgrade_success",[b._t("building_name_"+ this.type),this.level,this.getUpgradeCost()])};this.updateBtnDesc();this.stage.panel.balloontip.msg(bW,bU)},step:function(){if(this.blink){this.wait_blink--;if(this.wait_blink<  -this._default_wait_blink){this.wait_blink= this._default_wait_blink}};this.findTarget();this.tryToFire()},render:function(){if(!this.is_visiable|| this.wait_blink< 0){return};var bh=b.ctx;b.renderBuilding(this);if(this.is_pre_building&& this.is_weapon&& this.grid){bh.lineWidth= _TD.retina;bh.fillStyle= "rgba(187, 141, 32, 0.15)";bh.strokeStyle= "#bb8d20";bh.beginPath();bh.arc(this.cx,this.cy,this.range_px,0,Math.PI* 2,true);bh.closePath();bh.fill();bh.stroke()}},onEnter:function(){var bW;if(this.map.is_main_map){if(this.is_pre_building||  !this.is_weapon){return};bW= b._t("score_info",[this.killed])}else {if(!this.is_weapon){bW= b._t("building_intro_"+ this.type,[this.cost])}else {bW= b._t("building_info",[b._t("building_name_"+ this.type),this.cost,this.damage,this.speed,this.range])}};this.stage.panel.balloontip.msg(bW,this.grid)},onOut:function(){if(this.stage.panel.balloontip.el== this.grid){this.stage.panel.balloontip.hide()}},onClick:function(){if(this.is_pre_building){return};if(this.map.is_main_map){}else {this.map.eachBuilding(function(bD){bD.is_selected= false;bD.grid.highLight(false)});this.is_selected= true;this.grid.highLight(true);this.map.selected_building= this;this.stage.preBuild(this.type)}}};b.Building= function(bv,bk){bk.on_events= ["enter","out","click"];var bX= new b.Element(bv,bk);b.lang.mix(bX,bG);bX._init(bk);return bX};var bH={_init:function(bk){bk= bk|| {};this.speed= bk.speed;this.damage= bk.damage;this.target= bk.target;this.cx= bk.x;this.cy= bk.y;this.r= bk.r|| Math.max(Math.log(this.damage),2);if(this.r< 1){this.r= 1};if(this.r> 6){this.r= 6};this.r*= _TD.retina;this.building= bk.building;this.map= this.building.map;this.type= bk.type|| 1;this.color= bk.color|| "#000";this.map.bullets.push(this);this.map.stage.addElement(this,1,6);this.caculate()},caculate:function(){var cb=this.target.cx,cc=this.target.cy;var bZ=cb- this.cx,ca=cc- this.cy;sx2= Math.pow(bZ,2),sy2= Math.pow(ca,2);c= Math.sqrt(sx2+ sy2);speed= 20* this.speed;var bY=c/ speed* this.target.speed;switch(this.target.toward){case 0:ca+= bY;sy2= Math.pow(ca,2);break;case 1:bZ+= bY;sx2= Math.pow(bZ,2);break;case 2:ca-= bY;sy2= Math.pow(ca,2);break;case 3:bZ-= bY;sx2= Math.pow(bZ,2);break};c= Math.sqrt(sx2+ sy2);speed*= b.global_speed;this.vx= bZ* speed/ c;this.vy= ca* speed/ c;this.edx= Math.abs(bZ)+ b.grid_size;this.edy= Math.abs(ca)+ b.grid_size},checkOutOfMap:function(){if(this.edy> this.edx){this.is_valid= Math.abs(this.cy- this.building.cy)< this.edy}else {this.is_valid= Math.abs(this.cx- this.building.cx)< this.edx};return !this.is_valid},checkHit:function(){var bK=this.cx,bL=this.cy;r= this.r;var bD=this.target;var bM=bD.cx- bK,bN=bD.cy- bL,cd=bD.r+ r;var ce=bM* bM+ bN* bN- cd* cd* 2;if(ce<= 0){bD.beHit(this.building,this.damage);this.is_valid= false;b.Explode(this.id+ "-explode",{cx:this.cx,cy:this.cy,r:this.r,color:this.color,stage:this.stage,time:0.2});return true;checkHit}else {return false}},step:function(){if(this.checkHit()|| this.checkOutOfMap()){return};this.cx+= this.vx;this.cy+= this.vy},render:function(){var bh=b.ctx;bh.fillStyle= this.color;bh.beginPath();bh.arc(this.cx,this.cy,this.r,0,Math.PI* 2,true);bh.closePath();bh.fill()}};b.Bullet= function(bv,bk){var cf= new b.Element(bv,bk);b.lang.mix(cf,bH);cf._init(bk);return cf}});_TD.a.push(function(b){var cg={_init:function(bk){bk= bk|| {};this.map= bk.map;this.stage= this.map.stage;this.mx= bk.mx;this.my= bk.my;this.width= b.grid_size;this.height= b.grid_size;this.is_entrance= this.is_exit= false;this.passable_flag= 1;this.build_flag= 1;this.building= null;this.caculatePos()},caculatePos:function(){this.x= this.map.x+ this.mx* b.grid_size;this.y= this.map.y+ this.my* b.grid_size;this.x2= this.x+ b.grid_size;this.y2= this.y+ b.grid_size;this.cx= Math.floor(this.x+ b.grid_size/ 2);this.cy= Math.floor(this.y+ b.grid_size/ 2)},checkBlock:function(){if(this.is_entrance|| this.is_exit){this._block_msg= b._t("entrance_or_exit_be_blocked");return true};var ci,g=this,ch= new b.FindWay(this.map.grid_x,this.map.grid_y,this.map.entrance.mx,this.map.entrance.my,this.map.exit.mx,this.map.exit.my,function(m,n){return !(m== g.mx&& n== g.my)&& g.map.checkPassable(m,n)});ci= ch.is_blocked;if(!ci){ci=  !!this.map.anyMonster(function(bD){return bD.chkIfBlocked(g.mx,g.my)});if(ci){this._block_msg= b._t("monster_be_blocked")}}else {this._block_msg= b._t("blocked")};return ci},addBuilding:function(X){if(this.building){this.stage.money+= this.building.getSellMoney();this.removeBuilding()};var bX= new b.Building("building-"+ X+ "-"+ b.lang.rndStr(),{type:X,stage:this.stage,map:this,is_pre_building:false});bX.locate(this);if(bX.is_weapon){this.map.buildings.push(bX);if(this.map.is_main_map){this.stage.has_weapon= true}};this.building= bX;this.build_flag= 2;if(this.map.pre_building){this.map.pre_building.hide()}},removeBuilding:function(){if(this.build_flag== 2){this.build_flag= 1};if(this.building){let cj=this.building.id;let I=this.map.buildings;for(var a in I){if(I[a].id== cj){I.shift();break}};this.building.remove()};this.building= null},addMonster:function(ck){ck.beAddToGrid(this);this.map.monsters.push(ck);ck.start()},highLight:function(cl){this.map.select_hl[cl?"show":"hide"](this)},render:function(){var bh=b.ctx,cm=this.x+ 0.5,cn=this.y+ 0.5;if(this.is_hover){bh.fillStyle= "rgba(255, 255, 200, 0.2)";bh.beginPath();bh.fillRect(cm,cn,this.width,this.height);bh.closePath();bh.fill()};if(this.passable_flag== 0){bh.fillStyle= "#fcc";bh.beginPath();bh.fillRect(cm,cn,this.width,this.height);bh.closePath();bh.fill()};if(this.is_entrance|| this.is_exit){bh.lineWidth= 1;bh.fillStyle= "#ccc";bh.beginPath();bh.fillRect(cm,cn,this.width,this.height);bh.closePath();bh.fill();bh.strokeStyle= "#666";bh.fillStyle= this.is_entrance?"#fff":"#666";bh.beginPath();bh.arc(this.cx,this.cy,b.grid_size* 0.325,0,Math.PI* 2,true);bh.closePath();bh.fill();bh.stroke()};bh.strokeStyle= "#eee";bh.lineWidth= 1;bh.beginPath();bh.strokeRect(cm,cn,this.width,this.height);bh.closePath();bh.stroke()},onEnter:function(){if(this.map.is_main_map){if(b.mode== 1){this.map.pre_building.show();this.map.pre_building.locate(this)}else {var bW="";if(this.is_entrance){bW= b._t("entrance")}else {if(this.is_exit){bW= b._t("exit")}else {if(this.passable_flag== 0){bW= b._t("_cant_pass")}else {if(this.build_flag== 0){bW= b._t("_cant_build")}}}};if(bW){this.stage.panel.balloontip.msg(bW,this)}}}},onOut:function(){if(this.stage.panel.balloontip.el== this){this.stage.panel.balloontip.hide()}},onClick:function(){if(this.stage.state!= 1){return};if(this.map.is_main_map){if(b.mode== 1){var cp=this.map.pre_building.type;if(cp== "hammer"){if(this.building){this.stage.money+= this.building.getSellMoney();this.removeBuilding()};return};var co=this.map.pre_building.cost;if(this.building){if(this.building.cost>= co){return}};if(this.checkBlock()){if(cp== "wall"){this.stage.panel.balloontip.msg(this._block_msg,this)}else {this.stage.cancelPreBuild()}}else {if(this.stage.money>= co){this.stage.money-= co;this.addBuilding(cp);if(this.stage.money< co){b.stage.cancelPreBuild()}}else {b.stage.cancelPreBuild();this.stage.panel.balloontip.msg(b._t("not_enough_money",[co]),this)}}}}else {if(!this.building&& this.map.selected_building){this.stage.cancelPreBuild()}}}};b.Grid= function(bv,bk){bk.on_events= ["enter","out","click"];var bJ= new b.Element(bv,bk);b.lang.mix(bJ,cg);bJ._init(bk);return bJ}});_TD.a.push(function(b){var cq=20;var ct={_init:function(bk){bk= bk|| {};this._add_delay= 0;this.grid_x= bk.grid_x|| 10;this.grid_y= bk.grid_y|| 10;this.x= bk.x|| 0;this.y= bk.y|| 0;this.width= this.grid_x* b.grid_size;this.height= this.grid_y* b.grid_size;this.x2= this.x+ this.width;this.y2= this.y+ this.height;this.grids= [];this.entrance= this.exit= null;this.buildings= [];this.monsters= [];this.bullets= [];this.is_main_map= bk.is_main_map;this.selected_building= null;this._wait_clearInvalidElements= cq;this._wait_add_monsters= 0;bk.stage.addElement(this,1,2);var a,H=this.grid_x* this.grid_y,cw=bk["grid_data"]|| [],bf,bJ;for(a= 0;a< H;a++){bf= cw[a]|| {};bf.mx= a% this.grid_x;bf.my= Math.floor(a/ this.grid_x);bf.map= this;bJ=  new b.Grid(this.id+ "-grid-"+ bf.mx+ "-"+ bf.my,bf);this.grids.push(bJ)};bk.stage.addElements(this.grids,1,this.render_level+ 1);if(bk.entrance&& bk.exit&&  !b.lang.arrayEqual(bk.entrance,bk.exit)){this.entrance= this.getGrid(bk.entrance[0],bk.entrance[1]);this.entrance.is_entrance= true;this.exit= this.getGrid(bk.exit[0],bk.exit[1]);this.exit.is_exit= true};var g=this;if(bk.grids_cfg){b.lang.each(bk.grids_cfg,function(bD){var bJ=g.getGrid(bD.pos[0],bD.pos[1]);if(!bJ){return};if(!isNaN(bD.passable_flag)){bJ.passable_flag= bD.passable_flag};if(!isNaN(bD.build_flag)){bJ.build_flag= bD.build_flag};if(bD.building){bJ.addBuilding(bD.building)}})};this.select_hl= b.MapSelectHighLight(this.id+ "-hl",{map:this})},getGrid:function(cz,cA){var T=cA* this.grid_x+ cz;return this.grids[T]},anyMonster:function(G){return b.lang.any(this.monsters,G)},anyBuilding:function(G){return b.lang.any(this.buildings,G)},anyBullet:function(G){return b.lang.any(this.bullets,G)},eachBuilding:function(G){b.lang.each(this.buildings,G)},eachMonster:function(G){b.lang.each(this.monsters,G)},eachBullet:function(G){b.lang.each(this.bullets,G)},clearInvalidElements:function(){if(this._wait_clearInvalidElements> 0){this._wait_clearInvalidElements--;return};this._wait_clearInvalidElements= cq;var J=[];b.lang.shift(this.buildings,function(bD){if(bD.is_valid){J.push(bD)}});this.buildings= J;J= [];b.lang.shift(this.monsters,function(bD){if(bD.is_valid){J.push(bD)}});this.monsters= J;J= [];b.lang.shift(this.bullets,function(bD){if(bD.is_valid){J.push(bD)}});this.bullets= J},addMonster:function(bl){if(!this.entrance){return};monster=  new b.Monster(null,{stage:this.stage});this.entrance.addMonster(monster)},checkPassable:function(cz,cA){var bJ=this.getGrid(cz,cA);return (bJ!= null&& bJ.passable_flag== 1&& bJ.build_flag!= 2)},step:function(){this.clearInvalidElements();if(this._wait_add_monsters> 0){if(this._add_delay== 0){this.addMonster();this._wait_add_monsters--;this._add_delay= 10}else {this._add_delay--}}},render:function(){var bh=b.ctx;bh.strokeStyle= "#99a";bh.lineWidth= _TD.retina;bh.beginPath();bh.strokeRect(this.x+ 0.5,this.y+ 0.5,this.width,this.height);bh.closePath();bh.stroke()},onOut:function(){if(this.is_main_map&& this.pre_building){this.pre_building.hide()}}};b.Map= function(bv,bk){bk.on_events= ["enter","out"];var cB= new b.Element(bv,bk);b.lang.mix(cB,ct);cB._init(bk);return cB};var cu={_init:function(bk){this.map= bk.map;this.width= b.grid_size+ 2;this.height= b.grid_size+ 2;this.is_visiable= false;this.map.stage.addElement(this,1,9)},show:function(bJ){this.x= bJ.x;this.y= bJ.y;this.is_visiable= true},render:function(){var bh=b.ctx;bh.lineWidth= 2;bh.strokeStyle= "#f93";bh.beginPath();bh.strokeRect(this.x,this.y,this.width- 1,this.height- 1);bh.closePath();bh.stroke()}};b.MapSelectHighLight= function(bv,bk){var cC= new b.Element(bv,bk);b.lang.mix(cC,cu);cC._init(bk);return cC};var cv={_init:function(bk){this.map= bk.map;this.stage= this.map.stage;this.x1= this.map.x;this.y1= this.map.y;this.x2= this.map.x2+ 1;this.y2= this.map.y2+ 1;this.w= this.stage.width;this.h= this.stage.height;this.w2= this.w- this.x2;this.h2= this.h- this.y2;this.stage.addElement(this,1,3)},render:function(){var bh=b.ctx;bh.fillStyle= "#fff";bh.beginPath();bh.fillRect(0,0,this.x1,this.h);bh.fillRect(0,0,this.w,this.y1);bh.fillRect(0,this.y2,this.w,this.h2);bh.fillRect(this.x2,0,this.w2,this.h);bh.closePath();bh.fill()}};function cs(bv,bk){var cD= new b.Element(bv,bk);b.lang.mix(cD,cv);cD._init(bk);return cD}});_TD.a.push(function(b){var cF={_init:function(bk){this.stage= bk.stage;this.is_monster= true;this.speed= 9+ Math.ceil(18* Math.random()* this.stage.difficulty);this.life= this.life0= 5+ Math.ceil(27* this.stage.wave* Math.random());this.money= Math.ceil(this.life/ (4* this.stage.difficulty));this.damage= Math.ceil(Math.random()* 5);var cG=["#DAA520","#008000","#FF6100","#4169E1","#800080"];this.color= cG[this.damage- 1];this.r= 14;this.render= this.defaultMonsterRender;this.grid= null;this.map= null;this.next_grid= null;this.way= [];this.toward= 0;this._dx= 0;this._dy= 0;this.is_blocked= false},defaultMonsterRender:function(){if(!this.is_valid||  !this.grid){return};var bh=b.ctx;bh.strokeStyle= "#000";bh.lineWidth= 1;bh.fillStyle= this.color;bh.beginPath();bh.arc(this.cx,this.cy,this.r,0,Math.PI* 2,true);bh.closePath();bh.fill();bh.stroke();if(b.show_monster_life){var D=Math.floor(b.grid_size/ 4),H=D* 2- 2* _TD.retina;bh.fillStyle= "#000";bh.beginPath();bh.fillRect(this.cx- D,this.cy- this.r- 6,D* 2,4* _TD.retina);bh.closePath();bh.fillStyle= "#f00";bh.beginPath();bh.fillRect(this.cx- D+ _TD.retina,this.cy- this.r- (6- _TD.retina),this.life* H/ this.life0,2* _TD.retina);bh.closePath()}},caculatePos:function(){var M=this.r;this.x= this.cx- M;this.y= this.cy- M;this.x2= this.cx+ M;this.y2= this.cy+ M},beHit:function(bX,cI){if(!this.is_valid){return};this.life-= cI;if(this.life<= 0){this.beKilled(bX)};var cH=this.stage.panel.balloontip;if(cH.el== this){cH.text= b._t("monster_info",[this.life,this.speed,this.damage])}},beKilled:function(bX){if(!this.is_valid){return};this.life= 0;this.is_valid= false;this.stage.money+= this.money;bX.killed++;b.Explode(this.id+ "-explode",{cx:this.cx,cy:this.cy,color:this.color,r:this.r,stage:this.stage})},arrive:function(){this.grid= this.next_grid;this.next_grid= null;this.checkFinish()},findWay:function(){var g=this;var ch= new b.FindWay(this.map.grid_x,this.map.grid_y,this.grid.mx,this.grid.my,this.map.exit.mx,this.map.exit.my,function(m,n){return g.map.checkPassable(m,n)});this.way= ch.way},checkFinish:function(){if(this.grid&& this.map&& this.grid== this.map.exit){this.stage.life-= this.damage;this.stage.wave_damage+= 1;if(this.stage.life<= 0){this.stage.life= 0;this.stage.state= 3}else {this.pause();this.del()}}},beAddToGrid:function(bJ){this.grid= bJ;this.map= bJ.map;this.cx= bJ.cx;this.cy= bJ.cy;this.map.stage.addElement(this,1,bJ.render_level+ 1)},getToward:function(){if(!this.grid||  !this.next_grid){return};if(this.grid.my< this.next_grid.my){this.toward= 0}else {if(this.grid.mx< this.next_grid.mx){this.toward= 1}else {if(this.grid.my> this.next_grid.my){this.toward= 2}else {if(this.grid.mx> this.next_grid.mx){this.toward= 3}}}}},getNextGrid:function(){if(this.way.length== 0|| Math.random()< 0.1){this.findWay()};var cJ=this.way.shift();if(cJ&&  !this.map.checkPassable(cJ[0],cJ[1])){this.findWay();cJ= this.way.shift()};if(!cJ){return};this.next_grid= this.map.getGrid(cJ[0],cJ[1]);this.getToward()},chkIfBlocked:function(cz,cA){var g=this,ch= new b.FindWay(this.map.grid_x,this.map.grid_y,this.grid.mx,this.grid.my,this.map.exit.mx,this.map.exit.my,function(m,n){return !(m== cz&& n== cA)&& g.map.checkPassable(m,n)});return ch.is_blocked},beBlocked:function(){if(this.is_blocked){return};this.is_blocked= true;b.log("monster be blocked!")},step:function(){if(!this.is_valid|| this.is_paused ||  !this.grid){return};if(!this.next_grid){this.getNextGrid();if(!this.next_grid){this.beBlocked();return}};if(this.cx== this.next_grid.cx&& this.cy== this.next_grid.cy){this.arrive()}else {var cK=this.next_grid.cx- this.cx,cL=this.next_grid.cy- this.cy,bZ=cK< 0?-1:1,ca=cL< 0?-1:1,cM=this.speed* b.global_speed;if(Math.abs(cK)< cM&& Math.abs(cL)< cM){this.cx= this.next_grid.cx;this.cy= this.next_grid.cy;this._dx= cM- Math.abs(cK);this._dy= cM- Math.abs(cL)}else {this.cx+= cK== 0?0:bZ* (cM+ this._dx);this.cy+= cL== 0?0:ca* (cM+ this._dy);this._dx= 0;this._dy= 0}};this.caculatePos()},onClick:function(){if(b.mode== 1){return};let I=this.map.buildings;for(var a in I){var cN=I[a],bM=cN.cx- this.cx,bN=cN.cy- this.cy;if(bM* bM+ bN* bN<= cN.range2){cN.target= this}}},onEnter:function(){if(b.mode== 0){this.stage.panel.balloontip.msg(b._t("monster_info",[this.life,this.speed,this.damage]),this)}},onOut:function(){}};b.Monster= function(bv,bk){bk.on_events= ["enter","out","click"];var ck= new b.Element(bv,bk);b.lang.mix(ck,cF);ck._init(bk);return ck};var cE={_init:function(bk){bk= bk|| {};var cO=b.lang.rgb2Arr(bk.color);this.cx= bk.cx;this.cy= bk.cy;this.r= bk.r;this.rgb_r= cO[0];this.rgb_g= cO[1];this.rgb_b= cO[2];this.rgb_a= 1;this.wait= this.wait0= b.exp_fps* (bk.time|| 1);bk.stage.addElement(this,1,6)},step:function(){if(!this.is_valid){return};this.wait--;this.r++;this.is_valid= this.wait> 0;this.rgb_a= this.wait/ this.wait0},render:function(){var bh=b.ctx;bh.fillStyle= "rgba("+ this.rgb_r+ ","+ this.rgb_g+ ","+ this.rgb_b+ ","+ this.rgb_a+ ")";bh.beginPath();bh.arc(this.cx,this.cy,this.r,0,Math.PI* 2,true);bh.closePath();bh.fill()}};b.Explode= function(bv,bk){var cP= new b.Element(bv,bk);b.lang.mix(cP,cE);cP._init(bk);return cP}});_TD.a.push(function(b){var cT={_init:function(bk){bk= bk|| {};this.x= bk.x;this.y= bk.y;this.map= bk.main_map;bk.stage.addElement(this,1,6);this.gameover_obj=  new b.GameOver("panel-gameover",{panel:this,stage:this.stage,is_visiable:false,x:0,y:0,width:this.stage.width,height:this.stage.height});this.balloontip=  new b.BalloonTip("panel-balloon-tip",{stage:this.stage});this.btn_pause=  new b.Button("panel-btn-pause",{stage:this.stage,x:this.x,y:400* _TD.retina,is_visiable:false,text:b._t("button_pause_text"),onClick:function(){if(this.stage.state== 1){this.stage.state= 2;this.text= b._t("button_continue_text")}else {if(this.stage.state== 2){this.stage.state= 1;this.text= b._t("button_pause_text")}}}});this.btn_restart=  new b.Button("panel-btn-restart",{stage:this.stage,x:this.x,y:this.y+ 440* _TD.retina,is_visiable:true,text:b._t("button_restart_text"),onClick:function(){this.stage.state= 4}})},step:function(){if(this.stage.life_recover){this._life_recover= this._life_recover2= this.stage.life_recover;this._life_recover_wait= this._life_recover_wait2= b.exp_fps* 3;this.stage.life_recover= 0};if(this._life_recover&& (b.iframe% b.exp_fps_eighth== 0)){this.stage.life++;this._life_recover--}},render:function(){var bh=b.ctx;bh.textAlign= "left";bh.textBaseline= "top";bh.fillStyle= "#000";bh.font= "normal "+ (12* _TD.retina)+ "px \'Courier New\'";var cU=20* _TD.retina;var cV=this.y;bh.beginPath();bh.fillText(b._t("panel_money_title")+ this.stage.money,this.x,cV);cV+= cU;bh.fillText(b._t("panel_life_title")+ this.stage.life,this.x,cV);var cW=cV;cV+= cU;cV+= cU;bh.fillText(b._t("panel_monster_title")+ this.map.monsters.length,this.x,cV);cV+= cU;bh.fillText("wave "+ this.stage.wave,this.x,cV);if(this._life_recover_wait){var J=this._life_recover_wait/ this._life_recover_wait2;bh.fillStyle= "rgba(255, 0, 0, "+ J+ ")";bh.font= "bold "+ (12* _TD.retina)+ "px \'Verdana\'";bh.beginPath();bh.fillText("+"+ this._life_recover2,this.x+ 60* _TD.retina,cW);bh.closePath();this._life_recover_wait--};bh.closePath();bh.textAlign= "left";bh.fillStyle= "#666";bh.font= "normal "+ (12* _TD.retina)+ "px \'Courier New\'";bh.beginPath();bh.fillText("FPS: "+ b.fps,b.padding,b.stage.height- b.padding* 2);bh.closePath()}};b.Panel= function(bv,bk){var cX= new b.Element(bv,bk);b.lang.mix(cX,cT);cX._init(bk);return cX};var cQ={_init:function(bk){bk= bk|| {};bk.stage.addElement(this,1,7)},caculatePos:function(){var u=this.el;this.x= u.cx+ 0.5;this.y= u.cy+ 0.5;if(this.x+ this.width> this.stage.width- b.padding){this.x= this.x- this.width};this.px= this.x+ 5* _TD.retina;this.py= this.y+ 4* _TD.retina},msg:function(p,u){this.text= p;var bh=b.ctx;bh.font= "normal "+ (12* _TD.retina)+ "px \'Courier New\'";this.width= Math.max(bh.measureText(p).width+ 10* _TD.retina,b.lang.strLen2(p)* 6+ 10* _TD.retina);this.height= 20* _TD.retina;if(u&& u.cx&& u.cy){this.el= u;this.caculatePos();this.show()}},step:function(){if(!this.el||  !this.el.is_valid){this.hide();return};if(this.el.is_monster){this.caculatePos()}},render:function(){if(!this.el){return};var bh=b.ctx;bh.lineWidth= _TD.retina;bh.fillStyle= "rgba(255, 255, 0, 0.5)";bh.strokeStyle= "rgba(222, 222, 0, 0.9)";bh.beginPath();bh.rect(this.x,this.y,this.width,this.height);bh.closePath();bh.fill();bh.stroke();bh.textAlign= "left";bh.textBaseline= "top";bh.fillStyle= "#000";bh.font= "normal "+ (12* _TD.retina)+ "px \'Courier New\'";bh.beginPath();bh.fillText(this.text,this.px,this.py);bh.closePath()}};b.BalloonTip= function(bv,bk){var cH= new b.Element(bv,bk);b.lang.mix(cH,cQ);cH._init(bk);return cH};var cR={_init:function(bk){bk= bk|| {};this.text= bk.text;this.onClick= bk.onClick|| b.lang.nullFunc;this.x= bk.x;this.y= bk.y;this.width= bk.width|| 80* _TD.retina;this.height= bk.height|| 30* _TD.retina;this.font_x= this.x+ 8* _TD.retina;this.font_y= this.y+ 9* _TD.retina;this.desc= bk.desc|| "";bk.stage.addElement(this,1,7);this.caculatePos()},onEnter:function(){b.mouseHand(true);if(this.desc){this.stage.panel.balloontip.msg(this.desc,this)}},onOut:function(){b.mouseHand(false);if(this.stage.panel.balloontip.el== this){this.stage.panel.balloontip.hide()}},render:function(){var bh=b.ctx;bh.lineWidth= 2* _TD.retina;bh.fillStyle= this.is_hover?"#eee":"#ccc";bh.strokeStyle= "#999";bh.beginPath();bh.rect(this.x,this.y,this.width,this.height);bh.closePath();bh.fill();bh.stroke();bh.textAlign= "left";bh.textBaseline= "top";bh.fillStyle= "#000";bh.font= "normal "+ (12* _TD.retina)+ "px \'Courier New\'";bh.beginPath();bh.fillText(this.text,this.font_x,this.font_y);bh.closePath();bh.fill()}};b.Button= function(bv,bk){bk.on_events= ["enter","out","click"];var cY= new b.Element(bv,bk);b.lang.mix(cY,cR);cY._init(bk);return cY};var cS={_init:function(bk){this.panel= bk.panel;bk.stage.addElement(this,1,7)},render:function(){this.panel.btn_pause.hide();var bh=b.ctx;bh.textAlign= "center";bh.textBaseline= "middle";bh.fillStyle= "#ccc";bh.font= "bold 62px \'Verdana\'";bh.beginPath();bh.fillText("GAME OVER",this.width/ 2,this.height/ 2);bh.closePath();bh.fillStyle= "#f00";bh.font= "bold 60px \'Verdana\'";bh.beginPath();bh.fillText("GAME OVER",this.width/ 2,this.height/ 2);bh.closePath()}};b.GameOver= function(bv,bk){var bD= new b.Element(bv,bk);b.lang.mix(bD,cS);bD._init(bk);return bD};b.recover= function(C){this.stage.life_recover= C;b.log("life recover: "+ C)}});_TD.a.push(function(b){function cZ(bh,dj,dl,br,bt,bx){var bs,bu,J,K,T,dk,dg,dh,di;if(dj== br){bs= dj;bu= bt> dl?dl+ bx:dl- bx}else {if(dl== bt){bu= dl;bs= br> dj?dj+ bx:dj- bx}else {J= (dl- bt)/ (dj- br);K= dl- dj* J;dg= J* J+ 1;dh= 2* (J* (K- dl)- dj);di= Math.pow(K- dl,2)+ dj* dj- Math.pow(bx,2);T= Math.pow(dh,2)- 4* dg* di;if(T< 0){return [0,0]};T= Math.sqrt(T);dk= (-dh+ T) / (2* dg);if((br- dj> 0&& dk- dj> 0)|| (br- dj< 0&& dk- dj< 0)){bs= dk;bu= J* bs+ K}else {bs= (-dh- T) / (2* dg);bu= J* bs+ K}}};bh.lineCap= "round";bh.moveTo(dj,dl);bh.lineTo(bs,bu);return [bs,bu]}var da={"HMG":function(K,bh,cB,db,dc){var de=K.getTargetPosition();bh.fillStyle= "#369";bh.strokeStyle= "#000";bh.beginPath();bh.lineWidth= _TD.retina;bh.arc(K.cx,K.cy,dc- 5,0,Math.PI* 2,true);bh.closePath();bh.fill();bh.stroke();bh.lineWidth= 3* _TD.retina;bh.beginPath();bh.moveTo(K.cx,K.cy);K.muzzle= cZ(bh,K.cx,K.cy,de[0],de[1],dc);bh.closePath();bh.stroke();bh.lineWidth= _TD.retina;bh.fillStyle= "#66c";bh.beginPath();bh.arc(K.cx,K.cy,7* _TD.retina,0,Math.PI* 2,true);bh.closePath();bh.fill();bh.stroke();bh.fillStyle= "#ccf";bh.beginPath();bh.arc(K.cx+ 2,K.cy- 2,3* _TD.retina,0,Math.PI* 2,true);bh.closePath();bh.fill()},"LMG":function(K,bh,cB,db,dc){var de=K.getTargetPosition();bh.fillStyle= "#36f";bh.strokeStyle= "#000";bh.beginPath();bh.lineWidth= _TD.retina;bh.arc(K.cx,K.cy,7* _TD.retina,0,Math.PI* 2,true);bh.closePath();bh.fill();bh.stroke();bh.lineWidth= 2* _TD.retina;bh.beginPath();bh.moveTo(K.cx,K.cy);K.muzzle= cZ(bh,K.cx,K.cy,de[0],de[1],dc);bh.closePath();bh.fill();bh.stroke();bh.lineWidth= _TD.retina;bh.fillStyle= "#66c";bh.beginPath();bh.arc(K.cx,K.cy,5* _TD.retina,0,Math.PI* 2,true);bh.closePath();bh.fill();bh.stroke();bh.fillStyle= "#ccf";bh.beginPath();bh.arc(K.cx+ 1,K.cy- 1,2* _TD.retina,0,Math.PI* 2,true);bh.closePath();bh.fill()},"cannon":function(K,bh,cB,db,dc){var de=K.getTargetPosition();bh.fillStyle= "#933";bh.strokeStyle= "#000";bh.beginPath();bh.lineWidth= _TD.retina;bh.arc(K.cx,K.cy,dc- 2,0,Math.PI* 2,true);bh.closePath();bh.fill();bh.stroke();bh.lineWidth= 5* _TD.retina;bh.beginPath();bh.moveTo(K.cx,K.cy);K.muzzle= cZ(bh,K.cx,K.cy,de[0],de[1],dc);bh.closePath();bh.fill();bh.stroke();bh.lineWidth= _TD.retina;bh.fillStyle= "#630";bh.beginPath();bh.arc(K.cx,K.cy,dc- 5* _TD.retina,0,Math.PI* 2,true);bh.closePath();bh.fill();bh.stroke();bh.fillStyle= "#960";bh.beginPath();bh.arc(K.cx+ 1,K.cy- 1,8* _TD.retina,0,Math.PI* 2,true);bh.closePath();bh.fill();bh.fillStyle= "#fcc";bh.beginPath();bh.arc(K.cx+ 3,K.cy- 3,4* _TD.retina,0,Math.PI* 2,true);bh.closePath();bh.fill()},"wall":function(K,bh,cB,db,dc){bh.lineWidth= _TD.retina;bh.fillStyle= "#666";bh.strokeStyle= "#000";bh.fillRect(K.cx- dc+ 1,K.cy- dc+ 1,db- 1,db- 1);bh.beginPath();bh.moveTo(K.cx- dc+ 0.5,K.cy- dc+ 0.5);bh.lineTo(K.cx- dc+ 0.5,K.cy+ dc+ 0.5);bh.lineTo(K.cx+ dc+ 0.5,K.cy+ dc+ 0.5);bh.lineTo(K.cx+ dc+ 0.5,K.cy- dc+ 0.5);bh.lineTo(K.cx- dc+ 0.5,K.cy- dc+ 0.5);bh.moveTo(K.cx- dc+ 0.5,K.cy+ dc+ 0.5);bh.lineTo(K.cx+ dc+ 0.5,K.cy- dc+ 0.5);bh.moveTo(K.cx- dc+ 0.5,K.cy- dc+ 0.5);bh.lineTo(K.cx+ dc+ 0.5,K.cy+ dc+ 0.5);bh.closePath();bh.stroke()},"hammer":function(K,bh,cB,db,dc){bh.lineWidth= _TD.retina;bh.strokeStyle= "green";bh.beginPath();var df=dc/ 2;bh.moveTo(K.cx- df,K.cy+ df);bh.lineTo(K.cx+ df,K.cy- df);bh.moveTo(K.cx- df,K.cy- df);bh.lineTo(K.cx+ df,K.cy+ df);bh.closePath();bh.stroke()},"laser_gun":function(K,bh){bh.fillStyle= "#f00";bh.strokeStyle= "#000";bh.beginPath();bh.lineWidth= _TD.retina;bh.moveTo(K.cx,K.cy- 10* _TD.retina);bh.lineTo(K.cx- 8.66* _TD.retina,K.cy+ 5* _TD.retina);bh.lineTo(K.cx+ 8.66* _TD.retina,K.cy+ 5* _TD.retina);bh.lineTo(K.cx,K.cy- 10* _TD.retina);bh.closePath();bh.fill();bh.stroke();bh.fillStyle= "#60f";bh.beginPath();bh.arc(K.cx,K.cy,7* _TD.retina,0,Math.PI* 2,true);bh.closePath();bh.fill();bh.stroke();bh.fillStyle= "#000";bh.beginPath();bh.arc(K.cx,K.cy,3* _TD.retina,0,Math.PI* 2,true);bh.closePath();bh.fill();bh.fillStyle= "#666";bh.beginPath();bh.arc(K.cx+ 1,K.cy- 1,_TD.retina,0,Math.PI* 2,true);bh.closePath();bh.fill();bh.lineWidth= 3* _TD.retina;bh.beginPath();bh.moveTo(K.cx,K.cy);bh.closePath();bh.fill();bh.stroke()}};b.renderBuilding= function(bX){var bh=b.ctx,cB=bX.map,db=b.grid_size,dc=b.grid_size/ 2;(da[bX.type]|| da["wall"])(bX,bh,cB,db,dc)}});_TD.a.push(function(b){b.Stage= function(bv,bk){this.id= bv|| ("stage-"+ b.lang.rndStr());this.cfg= bk|| {};this.width= this.cfg.width|| 640;this.height= this.cfg.height|| 540;this.state= 0;this._step2= b.lang.nullFunc;this._step_elements= [[],[],[]];this._render_elements= [[],[],[],[],[],[],[],[],[],[]];this._init()};b.Stage.prototype= {_init:function(){if( typeof this.cfg.init== "function"){this.cfg.init.call(this)};if( typeof this.cfg.step2== "function"){this._step2= this.cfg.step2}},preBuild:function(X){b.mode= 1;if(this.map.pre_building){this.map.pre_building.remove()};this.map.pre_building=  new b.Building(this.id+ "-"+ "pre-building-"+ b.lang.rndStr(),{type:X,map:this.map,is_pre_building:true,stage:this})},cancelPreBuild:function(){b.mode= 0;this.panel_map.selected_building.grid.highLight(false);this.panel_map.selected_building= null;if(this.map.pre_building){this.map.pre_building.remove()}},step:function(){b.eventManager.step();if(this.state== 4){b.start()};if(this.state!= 1){return};var a,J;for(a= 0;a< 3;a++){J= [];var dm=this._step_elements[a];b.lang.shift(dm,function(bD){if(bD.is_valid){if(!bD.is_paused){bD.step()};J.push(bD)}else {setTimeout(function(){bD= null},500)}});this._step_elements[a]= J};this._step2()},render:function(){var a,J,bh=b.ctx;bh.clearRect(0,0,this.width,this.height);for(a= 0;a< 10;a++){J= [];var dm=this._render_elements[a];b.lang.shift(dm,function(bD){if(bD.is_valid){if(bD.is_visiable){bD.render()};J.push(bD)}});this._render_elements[a]= J};if(this.state== 3){this.panel.gameover_obj.show()}},addElement:function(u,dp,dn){dp= dp|| u.step_level|| 1;dn= dn|| u.render_level;this._step_elements[dp].push(u);this._render_elements[dn].push(u);u.stage= this;u.step_level= dp;u.render_level= dn},addElements:function(dq,dp,dn){var g=this;b.lang.each(dq,function(bD){g.addElement(bD,dp,dn)})}}});_TD.a.push(function(b){b.FindWay= function(dt,ds,br,bt,bs,bu,dr){this.m= [];this.w= dt;this.h= ds;this.x1= br;this.y1= bt;this.x2= bs;this.y2= bu;this.way= [];this.len= this.w* this.h;this.is_blocked= this.is_arrived= false;this.fPassable=  typeof dr== "function"?dr:function(){return true};this._init()};b.FindWay.prototype= {_init:function(){if(this.x1== this.x2&& this.y1== this.y2){this.is_arrived= true;this.way= [[this.x1,this.y1]];return};for(var a=0;a< this.len;a++){this.m[a]=  -2};this.x= this.x1;this.y= this.y1;this.distance= 0;this.current= [[this.x,this.y]];this.setVal(this.x,this.y,0);while(this.next()){}},getVal:function(m,n){var T=n* this.w+ m;return T< this.len?this.m[T]:-1},setVal:function(m,n,o){var T=n* this.w+ m;if(T> this.len){return false};this.m[T]= o},getNeighborsOf:function(m,n){var du=[];if(n> 0){du.push([m,n- 1])};if(m< this.w- 1){du.push([m+ 1,n])};if(n< this.h- 1){du.push([m,n+ 1])};if(m> 0){du.push([m- 1,n])};return du},getAllNeighbors:function(){var du=[],dv,a,bd,H=this.current.length;for(a= 0;a< H;a++){bd= this.current[a];dv= this.getNeighborsOf(bd[0],bd[1]);du= du.concat(dv)};return du},findWay:function(){var m=this.x2,n=this.y2,dB,dz=this.len,dC,du,a,H,o,dA=-1,dw;while((m!= this.x1|| n!= this.y1)&& dA!= 0&& this.way.length< dz){this.way.unshift([m,n]);du= this.getNeighborsOf(m,n);dC= du.length;dw= [];dA=  -1;for(a= 0;a< dC;a++){o= this.getVal(du[a][0],du[a][1]);if(o< 0){continue};if(dA< 0|| dA> o){dA= o}};for(a= 0;a< dC;a++){dB= du[a];if(dA== this.getVal(dB[0],dB[1])){dw.push(dB)}};H= dw.length;a= H> 1?Math.floor(Math.random()* H):0;dB= dw[a];m= dB[0];n= dB[1]}},arrive:function(){this.current= [];this.is_arrived= true;this.findWay()},blocked:function(){this.current= [];this.is_blocked= true},next:function(){var dD=this.getAllNeighbors(),dB,H=dD.length,dE=[],m,n,a,o;this.distance++;for(a= 0;a< H;a++){dB= dD[a];m= dB[0];n= dB[1];if(this.getVal(m,n)!=  -2){continue};if(this.fPassable(m,n)){o= this.distance;dE.push(dB)}else {o=  -1};this.setVal(m,n,o);if(m== this.x2&& n== this.y2){this.arrive();return false}};if(dE.length== 0){this.blocked();return false};this.current= dE;return true}}})